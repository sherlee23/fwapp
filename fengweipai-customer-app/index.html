<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>锋味派美食团购</title>
  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* --- Root Variables for Theming --- */
    :root {
      --primary: #d10000;
      --secondary: #000000;
      --accent: #f8b500;
      --light: #f8f8f8;
      --dark: #333333;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --bg-gradient: linear-gradient(135deg, #f9f9f9 0%, #eeeeee 100%);
      --section-bg: rgba(255, 255, 255, 0.95);
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-hover: 0 8px 16px rgba(0, 0, 0, 0.12);
      --border-radius: 12px;
      --font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
    }

    /* --- Base & Reset Styles --- */
    * { box-sizing: border-box; }
    body {
      font-family: var(--font-family);
      max-width: 750px;
      margin: 0 auto;
      padding: 0;
      background: var(--bg-gradient);
      color: var(--dark);
      line-height: 1.6;
    }

    /* --- Header --- */
    .header {
      text-align: center;
      padding: 25px 20px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      border-radius: 0 0 20px 20px;
      margin-bottom: 25px;
      box-shadow: var(--shadow);
    }
    .header h1 {
      margin: 0;
      font-size: clamp(26px, 5vw, 32px);
      font-weight: 700;
      letter-spacing: 1px;
    }

    /* --- Category Navigation --- */
    .category-nav {
      position: sticky;
      top: 0;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(5px);
      z-index: 100;
      padding: 10px 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin: 0 15px 20px 15px;
      border-radius: var(--border-radius);
    }
    .category-links {
      display: flex;
      overflow-x: auto;
      gap: 10px;
      padding-bottom: 5px;
      scrollbar-width: none;
    }
    .category-links::-webkit-scrollbar { display: none; }
    .category-link {
      white-space: nowrap;
      padding: 6px 12px;
      background: #f0f0f0;
      border-radius: 20px;
      text-decoration: none;
      color: var(--dark);
      font-size: 14px;
      transition: all 0.3s;
    }
    .category-link.active, .category-link:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-2px);
    }

    /* --- Main Content & Containers --- */
    .main-container { padding: 0 15px 25px 15px; }
    .container, .disclaimer-box, .payment-details-container, .admin-section {
      background: var(--section-bg);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: var(--shadow);
      border-left: 4px solid var(--primary);
    }
    .payment-details-container { background: #fff9f9; }

    /* --- Products --- */
    .category-title {
      font-size: 22px; font-weight: 700; margin: 35px 0 20px;
      padding-bottom: 8px; border-bottom: 3px solid var(--primary);
    }
    .product-list { display: grid; gap: 20px; }
    @media (min-width: 600px) { .product-list { grid-template-columns: 1fr 1fr; } }
    
    .product {
      background: white; border-radius: var(--border-radius); padding: 18px;
      box-shadow: var(--shadow); transition: all 0.3s ease;
      position: relative; overflow: hidden;
      display: flex; flex-direction: column;
    }
    .product:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }
    .product.out-of-stock { opacity: 0.6; background: #fafafa; }

    .product-image-container {
      width: 100%; height: 200px; overflow: hidden; border-radius: 8px; margin-bottom: 15px;
      position: relative; background: #f5f5f5; display: flex; align-items: center; justify-content: center;
    }
    .product-image { max-width: 100%; max-height: 100%; object-fit: contain; }
    
    .stock-badge {
      position: absolute; top: 10px; right: 10px; padding: 4px 10px;
      border-radius: 12px; font-size: 12px; font-weight: 600; color: white;
    }
    .low-stock-badge { background: var(--warning); color: var(--dark); }
    .out-of-stock-badge { background: var(--danger); }
    
    .product-name { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
    .product-price { color: var(--primary); font-size: 18px; font-weight: 700; margin-bottom: 10px; }
    .stock-info { font-size: 13px; color: #666; font-weight: 500; margin-bottom: 15px; }
    .quantity-control { display: flex; align-items: center; gap: 10px; margin-top: auto; }

    .quantity-btn {
      width: 40px; height: 40px; border: none; border-radius: 8px; background: var(--primary);
      color: white; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    .quantity-btn:disabled { background: #ccc; cursor: not-allowed; }
    .quantity-input { width: 60px; height: 40px; text-align: center; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; }

    /* --- Forms --- */
    .disclaimer-box h3, .payment-details-container h3 { margin-top: 0; color: var(--primary); }
    .disclaimer-checkbox { margin-top: 15px; display: flex; align-items: center; gap: 10px; }
    .disclaimer-checkbox input { width: 20px; height: 20px; flex-shrink: 0; }
    .form-group { margin-bottom: 25px; }
    .form-group label { display: block; margin-bottom: 10px; font-weight: 600; font-size: 17px; }
    
    input[type="text"], input[type="tel"], select, textarea {
      width: 100%; padding: 13px 15px; border: 2px solid #e0e0e0;
      border-radius: 10px; font-size: 16px; transition: all 0.3s;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(209, 0, 0, 0.2);
    }
    
    .error .form-control, .error textarea, .error select, .error .file-upload-label {
        border-color: var(--danger) !important;
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2) !important;
    }
    .error-message { color: var(--danger); font-size: 13px; margin-top: 5px; display: none; }
    .error .error-message { display: block; }
    
    .file-upload input[type="file"] { display: none; }
    .file-upload-label {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding: 20px; background: var(--light); border: 2px dashed #e0e0e0; border-radius: 10px;
        text-align: center; cursor: pointer; transition: all 0.3s;
    }
    .file-upload-label i { font-size: 24px; color: var(--primary); margin-bottom: 8px; }
    .file-upload-label .file-name { color: var(--primary); font-weight: bold; word-break: break-all; }
    
    /* --- Total & Buttons --- */
    .total {
        background: white; padding: 15px 20px; border-radius: 10px; margin: 20px 0;
        text-align: right; font-size: 18px; font-weight: bold; box-shadow: var(--shadow);
    }
    .total span { color: var(--primary); font-size: 24px; }
    
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      padding: 15px 25px; background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white; border: none; border-radius: 10px; font-size: 16px;
      font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: var(--shadow);
    }
    .btn:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); }
    .submit-btn { width: 100%; padding: 16px; font-size: 18px; margin-top: 25px; }

    /* --- Payment & Admin --- */
    .qr-code-container { display: flex; gap: 20px; justify-content: center; margin-top: 15px; flex-wrap: wrap; }
    .qr-code-container img { width: 45%; max-width: 200px; border-radius: 10px; box-shadow: var(--shadow); }
    #selfPickupAddress {
        display: none; background: #f0f8ff; padding: 15px; border-radius: 8px;
        margin-top: 15px; border-left: 4px solid #2196f3; font-size: 15px;
    }
    .admin-section { background: white; }
    .admin-section input[type="password"] { margin-bottom: 15px; }
    
    /* --- Dialogs, Toasts, Loaders (UX Elements) --- */
    #loadingOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px);
        display: none; justify-content: center; align-items: center; z-index: 9999;
    }
    .loading-spinner { text-align: center; color: white; }
    .loading-spinner i { font-size: 48px; margin-bottom: 16px; color: var(--primary); animation: spin 1.5s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    #confirmationDialog, #successDialog {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7); z-index: 1000;
      display: none; justify-content: center; align-items: center;
      padding: 20px; backdrop-filter: blur(5px);
    }
    .dialog-content {
      background: white; padding: 30px; border-radius: 15px;
      max-width: 500px; width: 100%; max-height: 90vh;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      animation: fadeIn 0.3s ease-out; overflow-y: auto;
    }
    .dialog-content h3 { margin-top: 0; color: var(--primary); }
    .dialog-content hr { border: none; border-top: 1px solid #eee; margin: 15px 0; }
    .dialog-content ul { padding-left: 20px; margin-top: 0; }

    .whatsapp-preview {
      background: #f5f5f5; padding: 15px; border-radius: 10px; margin-top: 15px;
      font-family: monospace; white-space: pre-wrap; max-height: 200px;
      overflow-y: auto; text-align: left;
    }
    #copyWhatsappMsg { background: #25D366; color: white; }

    .dialog-footer {
        margin-top:20px; display:flex; justify-content:space-between; gap:10px;
    }
    .dialog-footer button { flex: 1; }
    
    #successDialog .dialog-content { text-align: center; }
    #successDialog .dialog-footer { justify-content: center; }
    #successDialog .fa-check-circle { color: var(--success); font-size: 48px; margin-bottom: 15px; }

    .toast-container {
        position: fixed; top: 20px; left: 50%;
        transform: translateX(-50%); z-index: 1001;
        display: flex; flex-direction: column; gap: 10px;
    }
    .toast {
        padding: 12px 20px; border-radius: 8px; color: white;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        display: flex; align-items: center; gap: 10px;
        animation: slideIn 0.3s, fadeOut 0.3s 2.7s;
    }
    .toast.success { background-color: var(--success); }
    .toast.danger { background-color: var(--danger); }
    .toast.warning { background-color: var(--warning); color: var(--dark); }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
  </style>
</head>
<body>
  <div id="loadingOverlay">
    <div class="loading-spinner"><i class="fas fa-spinner"></i><p>处理中...</p></div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <div class="header">
    <h1><i class="fas fa-utensils"></i> 锋味派美食团购</h1>
  </div>

  <div class="category-nav">
    <div class="category-links" id="categoryLinks"></div>
  </div>
  
  <div class="main-container">
    <form id="orderForm" novalidate>
      <div class="disclaimer-box" id="disclaimerBox">
        <h3><i class="fas fa-exclamation-triangle"></i> 重要声明 / Important Notice</h3>
        <p>1. 此为预购商品，订单汇总后统一向供应商订购。</p>
        <p>2. 预计等待时间：30-60天（从下单日起计算）。</p>
        <p>3. 当前价格已包含国际运费，可是不包括本地配送，可以选择自取，也可以安排配送，Klang Valley地区每单配送费用为RM20。</p>
        <p>4. 如果需要配送，请在备注栏框写下需要配送的地址，到货后可以直接安排。</p>
        <p>4. 如果有任何其他产品想要尝试，可以PM我或者直接在备注栏里留下产品链接，我尽量安排。 </p>

        <div class="disclaimer-checkbox">
          <input type="checkbox" id="agreeCheckbox" />
          <label for="agreeCheckbox">我已阅读并同意上述条款 / I have read and agree</label>
        </div>
        <div class="error-message">请勾选此项以继续</div>
      </div>

      <div class="container">
        <div class="form-group" id="nameGroup">
          <label for="name"><i class="fas fa-user"></i> 姓名 Name *</label>
          <input type="text" id="name" class="form-control" />
          <div class="error-message">请输入姓名</div>
        </div>

        <div class="form-group" id="phoneGroup">
          <label for="phone"><i class="fas fa-phone"></i> 电话 Phone *</label>
          <input type="tel" id="phone" class="form-control" placeholder="e.g. 0123456789" />
          <div class="error-message">请输入有效的电话号码</div>
        </div>

        <div class="form-group" id="deliveryGroup">
          <label for="delivery"><i class="fas fa-truck"></i> 取货方式 Delivery Method *</label>
          <select id="delivery" class="form-control">
            <option value="">请选择 / Please select</option>
            <option value="self-pickup">自取 Self pickup</option>
            <option value="lalamove">Lalamove 送货</option>
          </select>
          <div id="selfPickupAddress">
              <p><strong>自取地址：</strong> 667, Jalan 24, Taman Perindustrian Ehsan Jaya, Kepong, 52100, Kuala Lumpur.</p>
              <p><strong>联络号码：</strong> 0162327792</p>
              <p><strong>取货时间：</strong> 另行通知</p>
          </div>
          <div class="error-message">请选择取货方式</div>
        </div>
      </div>

      <h2 class="category-title">🛒 请选择商品</h2>
      <div id="productList" class="product-list"></div>

      <div class="total">共计：RM<span id="totalAmount">0.00</span></div>
      
      <div class="container">
        <div class="form-group">
          <label for="remarks"><i class="fas fa-comment-dots"></i> 备注（如有）Remarks</label>
          <textarea id="remarks" rows="3" placeholder="可填写特殊需求、配送说明等..."></textarea>
        </div>
      </div>
      
      <!-- Payment Section -->
      <div class="container">
        <div class="form-group" id="paymentMethodGroup">
          <label for="paymentMethod"><i class="fas fa-money-bill-wave"></i> 付款方式 Payment Method *</label>
          <select id="paymentMethod" class="form-control">
            <option value="">请选择 / Please select</option>
            <option value="Maybank QR">Maybank (DuitNow QR)</option>
            <option value="TNG eWallet">TNG eWallet (DuitNow QR)</option>
          </select>
          <div class="error-message">请选择付款方式</div>
        </div>
      </div>

      <div class="payment-details-container" id="paymentDetailsContainer" style="display:none;">
          <div id="maybankDetails" style="display:none;">
              <h3><i class="fas fa-university"></i> Maybank QR 付款</h3>
              <p><strong>银行名称 / Bank:</strong> Maybank</p>
              <p><strong>户口名 / Account Name:</strong> Choong Sher Lee</p>
              <p><strong>户口号码 / Account No.:</strong> 114209540438</p>
              <div class="qr-code-container">
                  <img src="IMG_4042.png" alt="Maybank QR Code">
              </div>
          </div>
          <div id="touchngoDetails" style="display:none;">
              <h3><i class="fas fa-mobile-alt"></i> TNG eWallet 付款</h3>
              <p>请使用您的 TNG eWallet App 扫描下方的 DuitNow QR 码进行支付。</p>
              <div class="qr-code-container">
                  <img src="IMG_4043.jpeg" alt="TNG eWallet DuitNow QR Code">
              </div>
          </div>
      </div>

      <div class="container">
        <div class="form-group" id="paymentProofGroup">
          <label for="paymentProof"><i class="fas fa-receipt"></i> 上传转账凭证 Upload Receipt *</label>
          <div class="file-upload">
            <input type="file" id="paymentProof" accept="image/*,.pdf"/>
            <label for="paymentProof" class="file-upload-label">
              <i class="fas fa-cloud-upload-alt"></i>
              <span id="fileUploadInitialText">点击或拖拽文件到此处</span>
              <span class="file-name"></span>
            </label>
          </div>
          <div class="error-message">请上传支付凭证</div>
        </div>
      </div>

      <button type="submit" class="submit-btn btn">
        <i class="fas fa-paper-plane"></i> 提交订单 Submit Order
      </button>
    </form>

    <div class="admin-section">
      <button class="btn" id="showExportBtn"><i class="fas fa-user-shield"></i> 管理员</button>
      <div id="adminPanel" style="display:none; margin-top: 15px;">
        <input type="password" id="adminPassword" placeholder="请输入管理员密码" />
        <button class="btn" id="realExportBtn"><i class="fas fa-file-excel"></i> 导出 Excel</button>
      </div>
    </div>
  </div>

  <!-- Dialogs -->
  <div id="confirmationDialog">
    <div class="dialog-content" id="confirmationContent"></div>
  </div>

  <div id="successDialog">
    <div class="dialog-content" id="successContent"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // --- CONFIGURATION ---
      const SUPABASE_URL = 'https://edfnhhthztskuuosuasw.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkZm5oaHRoenRza3V1b3N1YXN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5OTYxMTYsImV4cCI6MjA2NTU3MjExNn0.O3g2gjvsWagmWgmzoeJA8mPampvLYJr-KgqVwXsKoAo';
      const WHATSAPP_NUMBER = '60162327792';
      const ADMIN_PASSWORD = 'fengweipaiadmin';
      const CONTACT_PHONE = '0162327792';
      const SELF_PICKUP_ADDRESS = `667, Jalan 24, Taman Perindustrian Ehsan Jaya, Kepong, 52100, Kuala Lumpur.`;

      // --- PRODUCT DATA WITH STOCK ---
      let productsData = [
          { id: 1, name: '原味烤肠', price: 45, image: 'IMG_3859.jpeg', category: '烤肠系列', emoji: '🌭', },
          { id: 2, name: '烟熏蜜汁烤肠', price: 45, image: 'IMG_3864.jpeg', category: '烤肠系列', emoji: '🌭', },
          { id: 3, name: '法式香草烤肠', price: 45, image: 'IMG_3863.jpeg', category: '烤肠系列', emoji: '🌭', },
          { id: 4, name: '黑胡椒烤肠', price: 45, image: 'IMG_3860.jpeg', category: '烤肠系列', emoji: '🌭', },
          { id: 5, name: '孜然脆骨烤肠', price: 45, image: 'IMG_3862.jpeg', category: '烤肠系列', emoji: '🌭', },
          { id: 6, name: '芝士玉米烤肠', price: 45, image: 'IMG_3861.jpeg', category: '烤肠系列', emoji: '🌭', },
          { id: 7, name: '原味虾肠', price: 55, image: 'IMG_3853.jpeg', category: '虾肠系列', emoji: '🦐', },
          { id: 8, name: '辣味虾肠', price: 55, image: 'IMG_3854.jpeg', category: '虾肠系列', emoji: '🦐', },
          { id: 9, name: '原味虾饼', price: 48, image: 'IMG_3873.jpeg', category: '虾肠系列', emoji: '🍤', },
          { id: 10, name: '玛格丽特披萨', price: 38, image: 'IMG_3841.jpeg', category: '披萨系列', emoji: '🍕', },
          { id: 11, name: '黑椒牛肉披萨', price: 38, image: 'IMG_3839.jpeg', category: '披萨系列', emoji: '🍕', },
          { id: 12, name: '奥尔良鸡肉披萨', price: 38, image: 'IMG_3840.jpeg', category: '披萨系列', emoji: '🍕',},
          { id: 13, name: '双料榴莲披萨', price: 60, image: 'IMG_3852.jpeg', category: '披萨系列', emoji: '🍕', },
          { id: 14, name: '鲜肉小笼汤包 ( 1 袋 9只）', price: 28, image: 'IMG_3874.jpeg', category: '小笼汤包系列', emoji: '🥟', },
          { id: 15, name: '菌菇小笼汤包 ( 1 袋 9只）', price: 28, image: 'IMG_3875.jpeg', category: '小笼汤包系列', emoji: '🥟', },
          { id: 16, name: '黑松露小笼汤包 ( 1 袋 6只）', price: 28, image: 'IMG_3876.jpeg', category: '小笼汤包系列', emoji: '🥟', },
          { id: 17, name: '黑猪肉酥饼 (一份 3袋，每 袋 4片）', price: 88, image: 'IMG_3837.jpeg', category: '酥饼系列', emoji: '🥮', },
          { id: 18, name: '安格斯牛肉酥饼 (一份 3袋，每 袋 4片）', price: 88, image: 'IMG_3838.jpeg', category: '酥饼系列', emoji: '🥮', },
          { id: 19, name: '原味鸡排', price: 38, image: 'IMG_3835.jpeg', category: '鸡排系列', emoji: '🍗',},
          { id: 20, name: '奥尔良鸡排', price: 38, image: 'IMG_3836.jpeg', category: '鸡排系列', emoji: '🍗', },
          { id: 21, name: '奥尔良鸡翅', price: 38, image: 'IMG_3865.jpeg', category: '鸡翅系列', emoji: '🍗', },
          { id: 22, name: '青花椒鸡翅', price: 38, image: 'IMG_3866.jpeg', category: '鸡翅系列', emoji: '🍗', },
          { id: 23, name: '黑猪三丁纸皮烧卖 ( 1 袋 6只）', price: 28, image: 'IMG_3843.jpeg', category: '纸皮烧卖系列', emoji: '🥟', },
          { id: 24, name: '黑椒牛肉纸皮烧卖 ( 1 袋 6只）', price: 28, image: 'IMG_3842.jpeg', category: '纸皮烧卖系列', emoji: '🥟', },
          { id: 25, name: '黑猪梅菜干纸皮烧卖 ( 1 袋 6只）', price: 28, image: 'IMG_3844.jpeg', category: '纸皮烧卖系列', emoji: '🥟', },
          { id: 26, name: '三丁芝士纸皮烧卖 ( 1 袋 6只）', price: 28, image: 'IMG_3845.jpeg', category: '纸皮烧卖系列', emoji: '🥟', },
          { id: 27, name: '乌米腊味纸皮烧卖 ( 1 袋 6只）', price: 28, image: 'IMG_3846.jpeg', category: '纸皮烧卖系列', emoji: '🥟', },
          { id: 28, name: '黑猪肉香菜水饺 ( 1 包 12只）', price: 28, image: 'IMG_4051.jpeg', category: '水饺系列', emoji: '🥟', },
          { id: 29, name: '黑猪肉紫苏水饺 ( 1 包 12只）', price: 28, image: 'IMG_4050.jpeg', category: '水饺系列', emoji: '🥟', },
          { id: 30, name: '原味黑猪肉小笼包 ( 1 包 8只）', price: 25, image: 'IMG_4053.jpeg', category: '小笼包系列', emoji: '🥟', },
          { id: 31, name: '川香火锅小笼包 ( 1 包 8只）', price: 25, image: 'IMG_4052.jpeg', category: '小笼包系列', emoji: '🥟', },
          { id: 32, name: '鲜花蒸饺墨鱼馅 ( 1 盒 10只）', price: 88, image: 'IMG_4054.jpeg', category: '蒸饺系列', emoji: '🥟', },
          { id: 33, name: '鲜花蒸饺鲅鱼馅 ( 1 盒 10只）', price: 88, image: 'IMG_4055.jpeg', category: '蒸饺系列', emoji: '🥟', },
          { id: 34, name: '酥皮烤肠', price: 98, image: 'IMG_5636.jpeg', category: '酥皮烤肠系列', emoji: '🌭', },

      ];

      // --- STATE & INITIALIZATION ---
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      let currentOrder = null;
      
      initializeApp();
      
      function initializeApp() {
        renderCategoryNav();
        renderAllProducts();
        setupEventListeners();
        showToast('欢迎光临锋味派团购！', 'success');
      }

      // --- RENDERING FUNCTIONS ---
      function renderAllProducts() {
        const productsListDiv = document.getElementById('productList');
        productsListDiv.innerHTML = '';
        const uniqueCategories = [...new Set(productsData.map(p => p.category))];
        
        uniqueCategories.forEach(category => {
            const categoryEmoji = productsData.find(p => p.category === category)?.emoji || '✨';
            const categoryHtmlId = `cat_${category.replace(/\s/g, '')}`;
            
            const categoryTitle = document.createElement('h3');
            categoryTitle.className = 'category-title';
            categoryTitle.id = categoryHtmlId;
            categoryTitle.innerHTML = `${categoryEmoji} ${category}`;
            productsListDiv.appendChild(categoryTitle);

            productsData.filter(p => p.category === category).forEach(product => {
              productsListDiv.appendChild(createProductElement(product));
            });
        });
        attachQuantityControlListeners();
        calculateTotal();
      }

      function createProductElement(product) {
          const productDiv = document.createElement('div');
          productDiv.className = 'product';
          if (product.stock === 0) productDiv.classList.add('out-of-stock');
          productDiv.dataset.id = product.id;

          let stockBadge = '';
          if (product.stock === 0) {
              stockBadge = `<div class="stock-badge out-of-stock-badge">已售完</div>`;
          } else if (product.stock > 0 && product.stock <= product.minStock) {
              stockBadge = `<div class="stock-badge low-stock-badge">库存紧张</div>`;
          }

          productDiv.innerHTML = `
              <div class="product-image-container">
                  <img src="${product.image}" class="product-image" alt="${product.name}">
                  ${stockBadge}
              </div>
              <div class="product-name">${product.emoji} ${product.name}</div>
              <div class="product-price">RM${product.price.toFixed(2)}</div>
              <div class="stock-info">库存: ${product.stock}</div>
              <div class="quantity-control">
                  <button type="button" class="quantity-btn minus" ${product.stock === 0 ? 'disabled' : ''}>-</button>
                  <input type="number" class="quantity-input" data-id="${product.id}" data-price="${product.price}" value="0" min="0" max="${product.stock}" ${product.stock === 0 ? 'disabled' : ''}>
                  <button type="button" class="quantity-btn plus" ${product.stock === 0 ? 'disabled' : ''}>+</button>
              </div>`;
          return productDiv;
      }

      function renderCategoryNav() {
        const categoryLinksDiv = document.getElementById('categoryLinks');
        categoryLinksDiv.innerHTML = '';
        const allLink = document.createElement('a');
        allLink.href = '#';
        allLink.className = 'category-link active';
        allLink.textContent = '全部商品';
        allLink.addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelector('.main-container').scrollIntoView({ behavior: 'smooth' });
            setActiveCategoryLink(allLink);
        });
        categoryLinksDiv.appendChild(allLink);
        const uniqueCategories = [...new Set(productsData.map(p => p.category))].sort();
        uniqueCategories.forEach(category => {
            const categoryEmoji = productsData.find(p => p.category === category)?.emoji || '✨';
            const link = document.createElement('a');
            const categoryHtmlId = `cat_${category.replace(/\s/g, '')}`;
            link.href = `#${categoryHtmlId}`;
            link.className = 'category-link';
            link.textContent = `${categoryEmoji} ${category}`;
            link.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById(categoryHtmlId)?.scrollIntoView({ behavior: 'smooth' });
                setActiveCategoryLink(link);
            });
            categoryLinksDiv.appendChild(link);
        });
      }

      function setActiveCategoryLink(activeLink) {
        document.querySelectorAll('.category-link').forEach(l => l.classList.remove('active'));
        activeLink.classList.add('active');
      }

      // --- EVENT LISTENERS ---
      function setupEventListeners() {
          document.getElementById('orderForm').addEventListener('submit', handleFormSubmit);
          
          document.querySelectorAll('.form-control, textarea, #agreeCheckbox, #paymentProof').forEach(el => {
            const eventType = el.type === 'checkbox' || el.type === 'file' || el.tagName === 'SELECT' ? 'change' : 'input';
            el.addEventListener(eventType, () => clearError(el.closest('.form-group, .disclaimer-box').id));
          });
          
          document.getElementById('delivery').addEventListener('change', (e) => {
            document.getElementById('selfPickupAddress').style.display = e.target.value === 'self-pickup' ? 'block' : 'none';
          });
          
          document.getElementById('paymentMethod').addEventListener('change', handlePaymentMethodChange);
          document.getElementById('paymentProof').addEventListener('change', handleFileChange);
          document.getElementById('showExportBtn').addEventListener('click', () => {
            const panel = document.getElementById('adminPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
          });
          document.getElementById('realExportBtn').addEventListener('click', handleAdminExport);
      }
      
      function attachQuantityControlListeners() {
        document.querySelectorAll('.quantity-control').forEach(control => {
            const input = control.querySelector('.quantity-input');
            const productId = parseInt(input.dataset.id);
            control.querySelector('.plus').addEventListener('click', () => updateQuantity(productId, 1));
            control.querySelector('.minus').addEventListener('click', () => updateQuantity(productId, -1));
            input.addEventListener('input', () => {
                const product = productsData.find(p => p.id === productId);
                let value = parseInt(input.value) || 0;
                if (value < 0) value = 0;
                if (value > product.stock) {
                    value = product.stock;
                    showToast(`${product.name} 库存仅剩 ${product.stock} 件`, 'warning');
                }
                input.value = value;
                calculateTotal();
            });
        });
      }

      // --- HANDLERS & LOGIC ---
      function handlePaymentMethodChange(e) {
          const method = e.target.value;
          const detailsContainer = document.getElementById('paymentDetailsContainer');
          const maybankDiv = document.getElementById('maybankDetails');
          const tngDiv = document.getElementById('touchngoDetails');

          detailsContainer.style.display = 'none';
          maybankDiv.style.display = 'none';
          tngDiv.style.display = 'none';

          if (method) {
              detailsContainer.style.display = 'block';
              if (method === 'Maybank QR') {
                  maybankDiv.style.display = 'block';
              } else if (method === 'TNG eWallet') {
                  tngDiv.style.display = 'block';
              }
          }
      }

      function updateQuantity(productId, change) {
          const input = document.querySelector(`.quantity-input[data-id='${productId}']`);
          const product = productsData.find(p => p.id === productId);
          let currentVal = parseInt(input.value);
          let newVal = currentVal + change;
          if (newVal < 0) newVal = 0;
          if (newVal > product.stock) {
              newVal = product.stock;
              showToast(`${product.name} 库存仅剩 ${product.stock} 件`, 'warning');
          }
          input.value = newVal;
          calculateTotal();
      }

      function calculateTotal() {
          let total = 0;
          document.querySelectorAll('.quantity-input').forEach(input => {
            total += (parseInt(input.value) || 0) * parseFloat(input.dataset.price);
          });
          document.getElementById('totalAmount').textContent = total.toFixed(2);
          return total;
      }
      
      function handleFileChange(e) {
        const label = document.querySelector('.file-upload-label');
        const initialText = document.getElementById('fileUploadInitialText');
        const fileNameDisplay = label.querySelector('.file-name');
        if (e.target.files.length > 0) {
            fileNameDisplay.textContent = e.target.files[0].name;
            initialText.style.display = 'none';
        } else {
            fileNameDisplay.textContent = '';
            initialText.style.display = 'block';
        }
      }

      async function handleFormSubmit(e) {
          e.preventDefault();
          if (!validateForm()) return;
          currentOrder = await buildOrderData();
          showConfirmationDialog(currentOrder);
      }
      async function submitOrder(cartItems, customerInfo) {
  try {
    // 步骤 1：检查每项商品库存 & 是否限购
    for (const item of cartItems) {
      const { data: product, error } = await supabase
        .from('products')
        .select('stock, limit_purchase')
        .eq('id', item.id)
        .single();

      if (error || !product) {
        alert(`无法获取商品「${item.name}」的信息`);
        return;
      }

      if (product.limit_purchase) {
        if (product.stock < item.quantity) {
          alert(`商品「${item.name}」库存不足，仅剩 ${product.stock} 件`);
          return;
        }
      }
    }

    // 步骤 2：提交订单
    const { data: orderResult, error: orderError } = await supabase
      .from('orders')
      .insert([{
        name: customerInfo.name,
        phone: customerInfo.phone,
        address: customerInfo.address,
        items: cartItems.map(i => ({
          product_id: i.id,
          quantity: i.quantity
        })),
        total: cartItems.reduce((sum, item) => sum + item.price * item.quantity, 0),
        status: 'pending',
        created_at: new Date().toISOString()
      }]);

    if (orderError) {
      alert('订单提交失败，请稍后重试');
      return;
    }

    // 步骤 3：扣除库存（仅限限购商品）
    for (const item of cartItems) {
      const { data: product, error } = await supabase
        .from('products')
        .select('stock, limit_purchase')
        .eq('id', item.id)
        .single();

      if (product.limit_purchase) {
        await supabase
          .from('products')
          .update({ stock: product.stock - item.quantity })
          .eq('id', item.id);
      }
    }

    alert('订单提交成功！感谢您的支持');
    // 清空购物车、表单、回首页等操作...
  } catch (err) {
    console.error('订单处理异常:', err);
    alert('系统异常，请稍后再试');
  }
}

      async function submitConfirmedOrder() {
          showDialog(false, 'confirmationDialog');
          showLoading(true);
          
          try {
            const file = document.getElementById('paymentProof').files[0];
            let paymentProofUrl = '';
            if (file) {
                const ext = file.name.split('.').pop();
                const filename = `proofs/${currentOrder.orderId}.${ext}`;
                const { error: uploadError } = await supabase.storage.from('payment-proofs').upload(filename, file, { upsert: true });
                if (uploadError) throw new Error(`凭证上传失败: ${uploadError.message}`);
                const { data: urlData } = supabase.storage.from('payment-proofs').getPublicUrl(filename);
                paymentProofUrl = urlData.publicUrl;
            }

            const { error: insertError } = await supabase.from('orders').insert([{
              order_id: currentOrder.orderId,
              name: currentOrder.name,
              phone: currentOrder.phone,
              delivery_method: currentOrder.delivery,
              payment_method: currentOrder.paymentMethod, // Save payment method
              remarks: currentOrder.remarks,
              order_items: currentOrder.items,
              total_amount: currentOrder.total,
              payment_proof_url: paymentProofUrl,
              status: 'pending',
              created_at: new Date().toISOString()
            }]);
            if (insertError) throw new Error(`订单保存失败: ${insertError.message}`);

            // Update local stock
            currentOrder.items.forEach(item => {
                const product = productsData.find(p => p.id === item.id);
                if (product) product.stock -= item.quantity;
            });
            
            showSuccessDialog();
            resetForm();
            renderAllProducts();
          } catch (error) {
            console.error('Submit Error:', error);
            showToast(error.message, 'danger');
          } finally {
            showLoading(false);
          }
      }

      function resetForm() {
          document.getElementById('orderForm').reset();
          document.querySelectorAll('.quantity-input').forEach(input => input.value = '0');
          calculateTotal();
          handleFileChange({target: {files:[]}});
          handlePaymentMethodChange({target: {value: ''}});
          document.getElementById('selfPickupAddress').style.display = 'none';
          document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
          currentOrder = null;
      }
      
      // --- VALIDATION ---
      function validateForm() {
          let isValid = true;
          let firstErrorElement = null;
          const setFirstError = (el) => { if (!firstErrorElement) firstErrorElement = el; };

          document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));

          if (!document.getElementById('agreeCheckbox').checked) {
              isValid = false; showError('disclaimerBox', '请勾选此项以继续');
              setFirstError(document.getElementById('disclaimerBox'));
          }
          if (!document.getElementById('name').value.trim()) {
              isValid = false; showError('nameGroup', '请输入姓名');
              setFirstError(document.getElementById('nameGroup'));
          }
          const phone = document.getElementById('phone').value.trim();
          const phoneRegex = /^(\+?6?01)[0-46-9]-?[0-9]{7,8}$/;
          if (!phoneRegex.test(phone.replace(/-/g, ''))) {
              isValid = false; showError('phoneGroup', '请输入有效的马来西亚电话号码');
              setFirstError(document.getElementById('phoneGroup'));
          }
          if (!document.getElementById('delivery').value) {
              isValid = false; showError('deliveryGroup', '请选择取货方式');
              setFirstError(document.getElementById('deliveryGroup'));
          }
          if (!document.getElementById('paymentMethod').value) {
              isValid = false; showError('paymentMethodGroup', '请选择付款方式');
              setFirstError(document.getElementById('paymentMethodGroup'));
          }
          if (calculateTotal() <= 0) {
              isValid = false; showToast('请至少选择一项商品', 'warning');
              setFirstError(document.getElementById('productList'));
          }
          if (document.getElementById('paymentProof').files.length === 0) {
              isValid = false; showError('paymentProofGroup', '请上传支付凭证');
              setFirstError(document.getElementById('paymentProofGroup'));
          }

          if (!isValid && firstErrorElement) {
              firstErrorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
          return isValid;
      }

      function showError(groupId, message) {
          const group = document.getElementById(groupId);
          if (group) {
              group.classList.add('error');
              const errorMsgEl = group.querySelector('.error-message');
              if(errorMsgEl) errorMsgEl.textContent = message;
          }
      }

      function clearError(groupId) {
          document.getElementById(groupId)?.classList.remove('error');
      }

      // --- DATA BUILDERS ---
      async function buildOrderData() {
          const items = [];
          document.querySelectorAll('.quantity-input').forEach(input => {
            const quantity = parseInt(input.value);
            if (quantity > 0) {
              const product = productsData.find(p => p.id === parseInt(input.dataset.id));
              items.push({ id: product.id, product: product.name, quantity, price: product.price, emoji: product.emoji });
            }
          });
          
          const orderId = await generateOrderId();
          return {
            orderId,
            name: document.getElementById('name').value.trim(),
            phone: document.getElementById('phone').value.trim().replace(/-/g, ''),
            delivery: document.getElementById('delivery').value,
            paymentMethod: document.getElementById('paymentMethod').value,
            remarks: document.getElementById('remarks').value.trim(),
            items,
            total: calculateTotal(),
          };
      }
      
      async function generateOrderId() {
          const today = new Date();
          const datePrefix = `FW${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
          try {
            const { count, error } = await supabase.from('orders').select('order_id', { count: 'exact' }).like('order_id', `${datePrefix}%`);
            if (error) { throw error; }
            return `${datePrefix}${String(count + 1).padStart(3, '0')}`;
          } catch(error) {
            console.warn('Error fetching order count, falling back to timestamp ID.', error);
            return `FW${Date.now().toString().slice(-8)}`;
          }
      }

      function buildWhatsAppMessage(order) {
          let msg = `🛎️ *锋味派新订单 #${order.orderId}*\n\n`;
          msg += `👤 *客户信息*\n`;
          msg += `  - 姓名: ${order.name}\n`;
          msg += `  - 电话: ${order.phone}\n`;
          msg += `  - 取货: ${order.delivery === 'self-pickup' ? '自取' : 'Lalamove'}\n`;
          msg += `  - 付款方式: ${order.paymentMethod}\n`;
          if (order.delivery === 'self-pickup') {
              msg += `  - 地址: ${SELF_PICKUP_ADDRESS}\n`;
          }
          msg += `\n🛒 *订单明细*\n`;
          order.items.forEach(item => {
            msg += `${item.emoji} ${item.product} × ${item.quantity} = RM${(item.quantity * item.price).toFixed(2)}\n`;
          });
          msg += `\n💰 *总金额: RM${order.total.toFixed(2)}*\n`;
          msg += `📝 *备注*: ${order.remarks || '无'}\n`;
          msg += `\n📅 *下单时间*: ${new Date().toLocaleString('en-MY')}`;
          return msg;
      }
      
      // --- UI & UX FUNCTIONS (Dialogs, Toasts, Loader) ---
      function showLoading(show) {
          document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
      }

      function showDialog(show, dialogId) {
          document.getElementById(dialogId).style.display = show ? 'flex' : 'none';
      }

      function showConfirmationDialog(order) {
          const content = document.getElementById('confirmationContent');
          content.innerHTML = `
            <h3><i class="fas fa-clipboard-check"></i> 订单确认</h3>
            <p><strong>订单号:</strong> ${order.orderId}</p>
            <p><strong>姓名:</strong> ${order.name}</p>
            <p><strong>电话:</strong> ${order.phone}</p>
            <p><strong>配送:</strong> ${order.delivery === 'self-pickup' ? '自取' : 'Lalamove'}</p>
            <p><strong>付款方式:</strong> ${order.paymentMethod}</p>
            ${order.delivery === 'self-pickup' ? `<p><strong>自取地址：</strong> ${SELF_PICKUP_ADDRESS}</p>` : ''}
            <hr/>
            <h4>订单明细</h4>
            <ul>${order.items.map(i => `<li>${i.product} × ${i.quantity} = RM${(i.quantity * i.price).toFixed(2)}</li>`).join('')}</ul>
            <p style="font-weight:bold;text-align:right;">总金额: RM${order.total.toFixed(2)}</p>
            <div class="dialog-footer">
              <button id="cancelConfirm" class="btn">取消</button>
              <button id="submitConfirm" class="btn">确认并提交</button>
            </div>`;
          showDialog(true, 'confirmationDialog');
          document.getElementById('cancelConfirm').onclick = () => showDialog(false, 'confirmationDialog');
          document.getElementById('submitConfirm').onclick = submitConfirmedOrder;
      }

      function showSuccessDialog() {
          const content = document.getElementById('successContent');
          const whatsappMsg = buildWhatsAppMessage(currentOrder);
          content.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <h3>订单提交成功！</h3>
            <p>您的订单 #${currentOrder.orderId} 已成功保存。</p>
            <p>请点击下方按钮，通过WhatsApp发送订单详情以完成流程。</p>
            <div class="dialog-footer">
              <button id="successConfirm" class="btn">前往WhatsApp发送</button>
            </div>`;
          showDialog(true, 'successDialog');
          document.getElementById('successConfirm').onclick = () => {
              showDialog(false, 'successDialog');
              window.location.href = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(whatsappMsg)}`;
          };
      }
      
      function showToast(message, type = 'success') {
          const container = document.getElementById('toastContainer');
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;
          const icons = { success: 'fa-check-circle', danger: 'fa-times-circle', warning: 'fa-exclamation-triangle' };
          toast.innerHTML = `<i class="fas ${icons[type]}"></i><span>${message}</span>`;
          container.appendChild(toast);
          setTimeout(() => toast.remove(), 3000);
      }

      // --- ADMIN FUNCTIONS ---
      async function handleAdminExport() {
          if (document.getElementById('adminPassword').value !== ADMIN_PASSWORD) {
              return showToast('管理员密码错误', 'danger');
          }
          showLoading(true);
          try {
            const { data: orders, error } = await supabase
              .from('orders').select('*').order('created_at', { ascending: false });
            if (error) throw error;
            if (!orders || orders.length === 0) {
                showToast('没有订单数据可供导出', 'warning');
                return;
            }

            const wsData = [['订单号', '姓名', '电话', '配送方式', '付款方式', '备注', '总金额', '状态', '下单时间', '支付凭证URL', '产品明细']];
            orders.forEach(order => {
              const productDetails = Array.isArray(order.order_items)
                ? order.order_items.map(item => `${item.product || 'N/A'} x ${item.quantity || 0}`).join('; ') : '无产品信息';
              wsData.push([
                order.order_id, order.name, order.phone, order.delivery_method,
                order.payment_method || 'N/A', order.remarks || '无', 
                order.total_amount, order.status,
                new Date(order.created_at).toLocaleString('en-MY'),
                order.payment_proof_url || '无', productDetails
              ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '订单数据');
            XLSX.writeFile(wb, `锋味派订单_${new Date().toISOString().slice(0, 10)}.xlsx`);
            showToast('导出成功！', 'success');
          } catch (error) {
            console.error('Export Error:', error);
            showToast(`导出订单时出错: ${error.message}`, 'danger');
          } finally {
            showLoading(false);
          }
      }
    });
  </script>
</body>
</html>
