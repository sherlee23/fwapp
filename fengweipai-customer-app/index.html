<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é”‹å‘³æ´¾ç¾é£Ÿå›¢è´­</title>
  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* --- Root Variables for Theming --- */
    :root {
      --primary: #d10000;
      --secondary: #000000;
      --accent: #f8b500;
      --light: #f8f8f8;
      --dark: #333333;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --bg-gradient: linear-gradient(135deg, #f9f9f9 0%, #eeeeee 100%);
      --section-bg: rgba(255, 255, 255, 0.95);
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-hover: 0 8px 16px rgba(0, 0, 0, 0.12);
      --border-radius: 12px;
      --font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
    }

    /* --- Base & Reset Styles --- */
    * { box-sizing: border-box; }
    body {
      font-family: var(--font-family);
      max-width: 750px;
      margin: 0 auto;
      padding: 0;
      background: var(--bg-gradient);
      color: var(--dark);
      line-height: 1.6;
    }

    /* --- Header --- */
    .header {
      text-align: center;
      padding: 25px 20px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      border-radius: 0 0 20px 20px;
      margin-bottom: 25px;
      box-shadow: var(--shadow);
    }
    .header h1 {
      margin: 0;
      font-size: clamp(26px, 5vw, 32px);
      font-weight: 700;
      letter-spacing: 1px;
    }

    /* --- Category Navigation --- */
    .category-nav {
      position: sticky;
      top: 0;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(5px);
      z-index: 100;
      padding: 10px 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin: 0 15px 20px 15px;
      border-radius: var(--border-radius);
    }
    .category-links {
      display: flex;
      overflow-x: auto;
      gap: 10px;
      padding-bottom: 5px;
      scrollbar-width: none;
    }
    .category-links::-webkit-scrollbar { display: none; }
    .category-link {
      white-space: nowrap;
      padding: 6px 12px;
      background: #f0f0f0;
      border-radius: 20px;
      text-decoration: none;
      color: var(--dark);
      font-size: 14px;
      transition: all 0.3s;
    }
    .category-link.active, .category-link:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-2px);
    }

    /* --- Main Content & Containers --- */
    .main-container { padding: 0 15px 25px 15px; }
    .container, .disclaimer-box, .payment-details-container, .admin-section {
      background: var(--section-bg);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: var(--shadow);
      border-left: 4px solid var(--primary);
    }
    .payment-details-container { background: #fff9f9; }

    /* --- Products --- */
    .category-title {
      font-size: 22px; font-weight: 700; margin: 35px 0 20px;
      padding-bottom: 8px; border-bottom: 3px solid var(--primary);
    }
    .product-list { display: grid; gap: 20px; }
    @media (min-width: 600px) { .product-list { grid-template-columns: 1fr 1fr; } }
    
    .product {
      background: white; border-radius: var(--border-radius); padding: 18px;
      box-shadow: var(--shadow); transition: all 0.3s ease;
      position: relative; overflow: hidden;
      display: flex; flex-direction: column;
    }
    .product:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }
    .product.out-of-stock { opacity: 0.6; background: #fafafa; }

    .product-image-container {
      width: 100%; height: 200px; overflow: hidden; border-radius: 8px; margin-bottom: 15px;
      position: relative; background: #f5f5f5; display: flex; align-items: center; justify-content: center;
    }
    .product-image { max-width: 100%; max-height: 100%; object-fit: contain; }
    
    .stock-badge {
      position: absolute; top: 10px; right: 10px; padding: 4px 10px;
      border-radius: 12px; font-size: 12px; font-weight: 600; color: white;
    }
    .low-stock-badge { background: var(--warning); color: var(--dark); }
    .out-of-stock-badge { background: var(--danger); }
    
    .product-name { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
    .product-price { color: var(--primary); font-size: 18px; font-weight: 700; margin-bottom: 10px; }
    .stock-info { font-size: 13px; color: #666; font-weight: 500; margin-bottom: 15px; }
    .quantity-control { display: flex; align-items: center; gap: 10px; margin-top: auto; }

    .quantity-btn {
      width: 40px; height: 40px; border: none; border-radius: 8px; background: var(--primary);
      color: white; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    .quantity-btn:disabled { background: #ccc; cursor: not-allowed; }
    .quantity-input { width: 60px; height: 40px; text-align: center; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; }

    /* --- Forms --- */
    .disclaimer-box h3, .payment-details-container h3 { margin-top: 0; color: var(--primary); }
    .disclaimer-checkbox { margin-top: 15px; display: flex; align-items: center; gap: 10px; }
    .disclaimer-checkbox input { width: 20px; height: 20px; flex-shrink: 0; }
    .form-group { margin-bottom: 25px; }
    .form-group label { display: block; margin-bottom: 10px; font-weight: 600; font-size: 17px; }
    
    input[type="text"], input[type="tel"], select, textarea {
      width: 100%; padding: 13px 15px; border: 2px solid #e0e0e0;
      border-radius: 10px; font-size: 16px; transition: all 0.3s;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(209, 0, 0, 0.2);
    }
    
    .error .form-control, .error textarea, .error select, .error .file-upload-label {
        border-color: var(--danger) !important;
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2) !important;
    }
    .error-message { color: var(--danger); font-size: 13px; margin-top: 5px; display: none; }
    .error .error-message { display: block; }
    
    .file-upload input[type="file"] { display: none; }
    .file-upload-label {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding: 20px; background: var(--light); border: 2px dashed #e0e0e0; border-radius: 10px;
        text-align: center; cursor: pointer; transition: all 0.3s;
    }
    .file-upload-label i { font-size: 24px; color: var(--primary); margin-bottom: 8px; }
    .file-upload-label .file-name { color: var(--primary); font-weight: bold; word-break: break-all; }
    
    /* --- Total & Buttons --- */
    .total {
        background: white; padding: 15px 20px; border-radius: 10px; margin: 20px 0;
        text-align: right; font-size: 18px; font-weight: bold; box-shadow: var(--shadow);
    }
    .total span { color: var(--primary); font-size: 24px; }
    
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      padding: 15px 25px; background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white; border: none; border-radius: 10px; font-size: 16px;
      font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: var(--shadow);
    }
    .btn:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); }
    .submit-btn { width: 100%; padding: 16px; font-size: 18px; margin-top: 25px; }

    /* --- Payment & Admin --- */
    .qr-code-container { display: flex; gap: 20px; justify-content: center; margin-top: 15px; flex-wrap: wrap; }
    .qr-code-container img { width: 45%; max-width: 200px; border-radius: 10px; box-shadow: var(--shadow); }
    #selfPickupAddress {
        display: none; background: #f0f8ff; padding: 15px; border-radius: 8px;
        margin-top: 15px; border-left: 4px solid #2196f3; font-size: 15px;
    }
    .admin-section { background: white; }
    .admin-section input[type="password"] { margin-bottom: 15px; }
    
    /* --- Dialogs, Toasts, Loaders (UX Elements) --- */
    #loadingOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px);
        display: none; justify-content: center; align-items: center; z-index: 9999;
    }
    .loading-spinner { text-align: center; color: white; }
    .loading-spinner i { font-size: 48px; margin-bottom: 16px; color: var(--primary); animation: spin 1.5s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    #confirmationDialog, #successDialog {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7); z-index: 1000;
      display: none; justify-content: center; align-items: center;
      padding: 20px; backdrop-filter: blur(5px);
    }
    .dialog-content {
      background: white; padding: 30px; border-radius: 15px;
      max-width: 500px; width: 100%; max-height: 90vh;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      animation: fadeIn 0.3s ease-out; overflow-y: auto;
    }
    .dialog-content h3 { margin-top: 0; color: var(--primary); }
    .dialog-content hr { border: none; border-top: 1px solid #eee; margin: 15px 0; }
    .dialog-content ul { padding-left: 20px; margin-top: 0; }

    .whatsapp-preview {
      background: #f5f5f5; padding: 15px; border-radius: 10px; margin-top: 15px;
      font-family: monospace; white-space: pre-wrap; max-height: 200px;
      overflow-y: auto; text-align: left;
    }
    #copyWhatsappMsg { background: #25D366; color: white; }

    .dialog-footer {
        margin-top:20px; display:flex; justify-content:space-between; gap:10px;
    }
    .dialog-footer button { flex: 1; }
    
    #successDialog .dialog-content { text-align: center; }
    #successDialog .dialog-footer { justify-content: center; }
    #successDialog .fa-check-circle { color: var(--success); font-size: 48px; margin-bottom: 15px; }

    .toast-container {
        position: fixed; top: 20px; left: 50%;
        transform: translateX(-50%); z-index: 1001;
        display: flex; flex-direction: column; gap: 10px;
    }
    .toast {
        padding: 12px 20px; border-radius: 8px; color: white;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        display: flex; align-items: center; gap: 10px;
        animation: slideIn 0.3s, fadeOut 0.3s 2.7s;
    }
    .toast.success { background-color: var(--success); }
    .toast.danger { background-color: var(--danger); }
    .toast.warning { background-color: var(--warning); color: var(--dark); }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
  </style>
</head>
<body>
  <div id="loadingOverlay">
    <div class="loading-spinner"><i class="fas fa-spinner"></i><p>å¤„ç†ä¸­...</p></div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <div class="header">
    <h1><i class="fas fa-utensils"></i> é”‹å‘³æ´¾ç¾é£Ÿå›¢è´­</h1>
  </div>

  <div class="category-nav">
    <div class="category-links" id="categoryLinks"></div>
  </div>
  
  <div class="main-container">
    <form id="orderForm" novalidate>
      <div class="disclaimer-box" id="disclaimerBox">
        <h3><i class="fas fa-exclamation-triangle"></i> é‡è¦å£°æ˜ / Important Notice</h3>
        <p>1. æ­¤ä¸ºé¢„è´­å•†å“ï¼Œè®¢å•æ±‡æ€»åç»Ÿä¸€å‘ä¾›åº”å•†è®¢è´­ã€‚</p>
        <p>2. é¢„è®¡ç­‰å¾…æ—¶é—´ï¼š30-60å¤©ï¼ˆä»ä¸‹å•æ—¥èµ·è®¡ç®—ï¼‰ã€‚</p>
        <p>3. å½“å‰ä»·æ ¼å·²åŒ…å«å›½é™…è¿è´¹ï¼Œå¯æ˜¯ä¸åŒ…æ‹¬æœ¬åœ°é…é€ï¼Œå¯ä»¥é€‰æ‹©è‡ªå–ï¼Œä¹Ÿå¯ä»¥å®‰æ’é…é€ï¼ŒKlang Valleyåœ°åŒºæ¯å•é…é€è´¹ç”¨ä¸ºRM20ã€‚</p>
        <p>4. å¦‚æœéœ€è¦é…é€ï¼Œè¯·åœ¨å¤‡æ³¨æ æ¡†å†™ä¸‹éœ€è¦é…é€çš„åœ°å€ï¼Œåˆ°è´§åå¯ä»¥ç›´æ¥å®‰æ’ã€‚</p>
        <p>4. å¦‚æœæœ‰ä»»ä½•å…¶ä»–äº§å“æƒ³è¦å°è¯•ï¼Œå¯ä»¥PMæˆ‘æˆ–è€…ç›´æ¥åœ¨å¤‡æ³¨æ é‡Œç•™ä¸‹äº§å“é“¾æ¥ï¼Œæˆ‘å°½é‡å®‰æ’ã€‚ </p>

        <div class="disclaimer-checkbox">
          <input type="checkbox" id="agreeCheckbox" />
          <label for="agreeCheckbox">æˆ‘å·²é˜…è¯»å¹¶åŒæ„ä¸Šè¿°æ¡æ¬¾ / I have read and agree</label>
        </div>
        <div class="error-message">è¯·å‹¾é€‰æ­¤é¡¹ä»¥ç»§ç»­</div>
      </div>

      <div class="container">
        <div class="form-group" id="nameGroup">
          <label for="name"><i class="fas fa-user"></i> å§“å Name *</label>
          <input type="text" id="name" class="form-control" />
          <div class="error-message">è¯·è¾“å…¥å§“å</div>
        </div>

        <div class="form-group" id="phoneGroup">
          <label for="phone"><i class="fas fa-phone"></i> ç”µè¯ Phone *</label>
          <input type="tel" id="phone" class="form-control" placeholder="e.g. 0123456789" />
          <div class="error-message">è¯·è¾“å…¥æœ‰æ•ˆçš„ç”µè¯å·ç </div>
        </div>

        <div class="form-group" id="deliveryGroup">
          <label for="delivery"><i class="fas fa-truck"></i> å–è´§æ–¹å¼ Delivery Method *</label>
          <select id="delivery" class="form-control">
            <option value="">è¯·é€‰æ‹© / Please select</option>
            <option value="self-pickup">è‡ªå– Self pickup</option>
            <option value="lalamove">Lalamove é€è´§</option>
          </select>
          <div id="selfPickupAddress">
              <p><strong>è‡ªå–åœ°å€ï¼š</strong> 667, Jalan 24, Taman Perindustrian Ehsan Jaya, Kepong, 52100, Kuala Lumpur.</p>
              <p><strong>è”ç»œå·ç ï¼š</strong> 0162327792</p>
              <p><strong>å–è´§æ—¶é—´ï¼š</strong> å¦è¡Œé€šçŸ¥</p>
          </div>
          <div class="error-message">è¯·é€‰æ‹©å–è´§æ–¹å¼</div>
        </div>
      </div>

      <h2 class="category-title">ğŸ›’ è¯·é€‰æ‹©å•†å“</h2>
      <div id="productList" class="product-list"></div>

      <div class="total">å…±è®¡ï¼šRM<span id="totalAmount">0.00</span></div>
      
      <div class="container">
        <div class="form-group">
          <label for="remarks"><i class="fas fa-comment-dots"></i> å¤‡æ³¨ï¼ˆå¦‚æœ‰ï¼‰Remarks</label>
          <textarea id="remarks" rows="3" placeholder="å¯å¡«å†™ç‰¹æ®Šéœ€æ±‚ã€é…é€è¯´æ˜ç­‰..."></textarea>
        </div>
      </div>
      
      <!-- Payment Section -->
      <div class="container">
        <div class="form-group" id="paymentMethodGroup">
          <label for="paymentMethod"><i class="fas fa-money-bill-wave"></i> ä»˜æ¬¾æ–¹å¼ Payment Method *</label>
          <select id="paymentMethod" class="form-control">
            <option value="">è¯·é€‰æ‹© / Please select</option>
            <option value="Maybank QR">Maybank (DuitNow QR)</option>
            <option value="TNG eWallet">TNG eWallet (DuitNow QR)</option>
          </select>
          <div class="error-message">è¯·é€‰æ‹©ä»˜æ¬¾æ–¹å¼</div>
        </div>
      </div>

      <div class="payment-details-container" id="paymentDetailsContainer" style="display:none;">
          <div id="maybankDetails" style="display:none;">
              <h3><i class="fas fa-university"></i> Maybank QR ä»˜æ¬¾</h3>
              <p><strong>é“¶è¡Œåç§° / Bank:</strong> Maybank</p>
              <p><strong>æˆ·å£å / Account Name:</strong> Choong Sher Lee</p>
              <p><strong>æˆ·å£å·ç  / Account No.:</strong> 114209540438</p>
              <div class="qr-code-container">
                  <img src="IMG_4042.png" alt="Maybank QR Code">
              </div>
          </div>
          <div id="touchngoDetails" style="display:none;">
              <h3><i class="fas fa-mobile-alt"></i> TNG eWallet ä»˜æ¬¾</h3>
              <p>è¯·ä½¿ç”¨æ‚¨çš„ TNG eWallet App æ‰«æä¸‹æ–¹çš„ DuitNow QR ç è¿›è¡Œæ”¯ä»˜ã€‚</p>
              <div class="qr-code-container">
                  <img src="IMG_4043.jpeg" alt="TNG eWallet DuitNow QR Code">
              </div>
          </div>
      </div>

      <div class="container">
        <div class="form-group" id="paymentProofGroup">
          <label for="paymentProof"><i class="fas fa-receipt"></i> ä¸Šä¼ è½¬è´¦å‡­è¯ Upload Receipt *</label>
          <div class="file-upload">
            <input type="file" id="paymentProof" accept="image/*,.pdf"/>
            <label for="paymentProof" class="file-upload-label">
              <i class="fas fa-cloud-upload-alt"></i>
              <span id="fileUploadInitialText">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</span>
              <span class="file-name"></span>
            </label>
          </div>
          <div class="error-message">è¯·ä¸Šä¼ æ”¯ä»˜å‡­è¯</div>
        </div>
      </div>

      <button type="submit" class="submit-btn btn">
        <i class="fas fa-paper-plane"></i> æäº¤è®¢å• Submit Order
      </button>
    </form>

    <div class="admin-section">
      <button class="btn" id="showExportBtn"><i class="fas fa-user-shield"></i> ç®¡ç†å‘˜</button>
      <div id="adminPanel" style="display:none; margin-top: 15px;">
        <input type="password" id="adminPassword" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç " />
        <button class="btn" id="realExportBtn"><i class="fas fa-file-excel"></i> å¯¼å‡º Excel</button>
      </div>
    </div>
  </div>

  <!-- Dialogs -->
  <div id="confirmationDialog">
    <div class="dialog-content" id="confirmationContent"></div>
  </div>

  <div id="successDialog">
    <div class="dialog-content" id="successContent"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // --- CONFIGURATION ---
      const SUPABASE_URL = 'https://edfnhhthztskuuosuasw.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkZm5oaHRoenRza3V1b3N1YXN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5OTYxMTYsImV4cCI6MjA2NTU3MjExNn0.O3g2gjvsWagmWgmzoeJA8mPampvLYJr-KgqVwXsKoAo';
      const WHATSAPP_NUMBER = '60162327792';
      const ADMIN_PASSWORD = 'fengweipaiadmin';
      const CONTACT_PHONE = '0162327792';
      const SELF_PICKUP_ADDRESS = `667, Jalan 24, Taman Perindustrian Ehsan Jaya, Kepong, 52100, Kuala Lumpur.`;

      // --- PRODUCT DATA WITH STOCK ---
      let productsData = [
          { id: 1, name: 'åŸå‘³çƒ¤è‚ ', price: 45, image: 'IMG_3859.jpeg', category: 'çƒ¤è‚ ç³»åˆ—', emoji: 'ğŸŒ­', },
          { id: 2, name: 'çƒŸç†èœœæ±çƒ¤è‚ ', price: 45, image: 'IMG_3864.jpeg', category: 'çƒ¤è‚ ç³»åˆ—', emoji: 'ğŸŒ­', },
          { id: 3, name: 'æ³•å¼é¦™è‰çƒ¤è‚ ', price: 45, image: 'IMG_3863.jpeg', category: 'çƒ¤è‚ ç³»åˆ—', emoji: 'ğŸŒ­', },
          { id: 4, name: 'é»‘èƒ¡æ¤’çƒ¤è‚ ', price: 45, image: 'IMG_3860.jpeg', category: 'çƒ¤è‚ ç³»åˆ—', emoji: 'ğŸŒ­', },
          { id: 5, name: 'å­œç„¶è„†éª¨çƒ¤è‚ ', price: 45, image: 'IMG_3862.jpeg', category: 'çƒ¤è‚ ç³»åˆ—', emoji: 'ğŸŒ­', },
          { id: 6, name: 'èŠå£«ç‰ç±³çƒ¤è‚ ', price: 45, image: 'IMG_3861.jpeg', category: 'çƒ¤è‚ ç³»åˆ—', emoji: 'ğŸŒ­', },
          { id: 7, name: 'åŸå‘³è™¾è‚ ', price: 55, image: 'IMG_3853.jpeg', category: 'è™¾è‚ ç³»åˆ—', emoji: 'ğŸ¦', },
          { id: 8, name: 'è¾£å‘³è™¾è‚ ', price: 55, image: 'IMG_3854.jpeg', category: 'è™¾è‚ ç³»åˆ—', emoji: 'ğŸ¦', },
          { id: 9, name: 'åŸå‘³è™¾é¥¼', price: 48, image: 'IMG_3873.jpeg', category: 'è™¾è‚ ç³»åˆ—', emoji: 'ğŸ¤', },
          { id: 10, name: 'ç›æ ¼ä¸½ç‰¹æŠ«è¨', price: 38, image: 'IMG_3841.jpeg', category: 'æŠ«è¨ç³»åˆ—', emoji: 'ğŸ•', },
          { id: 11, name: 'é»‘æ¤’ç‰›è‚‰æŠ«è¨', price: 38, image: 'IMG_3839.jpeg', category: 'æŠ«è¨ç³»åˆ—', emoji: 'ğŸ•', },
          { id: 12, name: 'å¥¥å°”è‰¯é¸¡è‚‰æŠ«è¨', price: 38, image: 'IMG_3840.jpeg', category: 'æŠ«è¨ç³»åˆ—', emoji: 'ğŸ•',},
          { id: 13, name: 'åŒæ–™æ¦´è²æŠ«è¨', price: 60, image: 'IMG_3852.jpeg', category: 'æŠ«è¨ç³»åˆ—', emoji: 'ğŸ•', },
          { id: 14, name: 'é²œè‚‰å°ç¬¼æ±¤åŒ… ( 1 è¢‹ 9åªï¼‰', price: 28, image: 'IMG_3874.jpeg', category: 'å°ç¬¼æ±¤åŒ…ç³»åˆ—', emoji: 'ğŸ¥Ÿ', },
          { id: 15, name: 'èŒè‡å°ç¬¼æ±¤åŒ… ( 1 è¢‹ 9åªï¼‰', price: 28, image: 'IMG_3875.jpeg', category: 'å°ç¬¼æ±¤åŒ…ç³»åˆ—', emoji: 'ğŸ¥Ÿ', },
          { id: 16, name: 'é»‘æ¾éœ²å°ç¬¼æ±¤åŒ… ( 1 è¢‹ 6åªï¼‰', price: 28, image: 'IMG_3876.jpeg', category: 'å°ç¬¼æ±¤åŒ…ç³»åˆ—', emoji: 'ğŸ¥Ÿ', },
          { id: 17, name: 'é»‘çŒªè‚‰é…¥é¥¼ (ä¸€ä»½ 3è¢‹ï¼Œæ¯ è¢‹ 4ç‰‡ï¼‰', price: 88, image: 'IMG_3837.jpeg', category: 'é…¥é¥¼ç³»åˆ—', emoji: 'ğŸ¥®', },
          { id: 18, name: 'å®‰æ ¼æ–¯ç‰›è‚‰é…¥é¥¼ (ä¸€ä»½ 3è¢‹ï¼Œæ¯ è¢‹ 4ç‰‡ï¼‰', price: 88, image: 'IMG_3838.jpeg', category: 'é…¥é¥¼ç³»åˆ—', emoji: 'ğŸ¥®', },
          { id: 19, name: 'åŸå‘³é¸¡æ’', price: 38, image: 'IMG_3835.jpeg', category: 'é¸¡æ’ç³»åˆ—', emoji: 'ğŸ—',},
          { id: 20, name: 'å¥¥å°”è‰¯é¸¡æ’', price: 38, image: 'IMG_3836.jpeg', category: 'é¸¡æ’ç³»åˆ—', emoji: 'ğŸ—', },
          { id: 21, name: 'å¥¥å°”è‰¯é¸¡ç¿…', price: 38, image: 'IMG_3865.jpeg', category: 'é¸¡ç¿…ç³»åˆ—', emoji: 'ğŸ—', },
          { id: 22, name: 'é’èŠ±æ¤’é¸¡ç¿…', price: 38, image: 'IMG_3866.jpeg', category: 'é¸¡ç¿…ç³»åˆ—', emoji: 'ğŸ—', },
          { id: 23, name: 'é»‘çŒªä¸‰ä¸çº¸çš®çƒ§å– ( 1 è¢‹ 6åªï¼‰', price: 28, image: 'IMG_3843.jpeg', category: 'çº¸çš®çƒ§å–ç³»åˆ—', emoji: 'ğŸ¥Ÿ', },
          { id: 24, name: 'é»‘æ¤’ç‰›è‚‰çº¸çš®çƒ§å– ( 1 è¢‹ 6åªï¼‰', price: 28, image: 'IMG_3842.jpeg', category: 'çº¸çš®çƒ§å–ç³»åˆ—', emoji: 'ğŸ¥Ÿ', },
          { id: 25, name: 'é»‘çŒªæ¢…èœå¹²çº¸çš®çƒ§å– ( 1 è¢‹ 6åªï¼‰', price: 28, image: 'IMG_3844.jpeg', category: 'çº¸çš®çƒ§å–ç³»åˆ—', emoji: 'ğŸ¥Ÿ', },
          { id: 26, name: 'ä¸‰ä¸èŠå£«çº¸çš®çƒ§å– ( 1 è¢‹ 6åªï¼‰', price: 28, image: 'IMG_3845.jpeg', category: 'çº¸çš®çƒ§å–ç³»åˆ—', emoji: 'ğŸ¥Ÿ', },
          { id: 27, name: 'ä¹Œç±³è…Šå‘³çº¸çš®çƒ§å– ( 1 è¢‹ 6åªï¼‰', price: 28, image: 'IMG_3846.jpeg', category: 'çº¸çš®çƒ§å–ç³»åˆ—', emoji: 'ğŸ¥Ÿ', },
          { id: 28, name: 'é»‘çŒªè‚‰é¦™èœæ°´é¥º ( 1 åŒ… 12åªï¼‰', price: 28, image: 'IMG_4051.jpeg', category: 'æ°´é¥ºç³»åˆ—', emoji: 'ğŸ¥Ÿ', },
          { id: 29, name: 'é»‘çŒªè‚‰ç´«è‹æ°´é¥º ( 1 åŒ… 12åªï¼‰', price: 28, image: 'IMG_4050.jpeg', category: 'æ°´é¥ºç³»åˆ—', emoji: 'ğŸ¥Ÿ', },
          { id: 30, name: 'åŸå‘³é»‘çŒªè‚‰å°ç¬¼åŒ… ( 1 åŒ… 8åªï¼‰', price: 25, image: 'IMG_4053.jpeg', category: 'å°ç¬¼åŒ…ç³»åˆ—', emoji: 'ğŸ¥Ÿ', },
          { id: 31, name: 'å·é¦™ç«é”…å°ç¬¼åŒ… ( 1 åŒ… 8åªï¼‰', price: 25, image: 'IMG_4052.jpeg', category: 'å°ç¬¼åŒ…ç³»åˆ—', emoji: 'ğŸ¥Ÿ', },
          { id: 32, name: 'é²œèŠ±è’¸é¥ºå¢¨é±¼é¦… ( 1 ç›’ 10åªï¼‰', price: 88, image: 'IMG_4054.jpeg', category: 'è’¸é¥ºç³»åˆ—', emoji: 'ğŸ¥Ÿ', },
          { id: 33, name: 'é²œèŠ±è’¸é¥ºé²…é±¼é¦… ( 1 ç›’ 10åªï¼‰', price: 88, image: 'IMG_4055.jpeg', category: 'è’¸é¥ºç³»åˆ—', emoji: 'ğŸ¥Ÿ', },
          { id: 34, name: 'é…¥çš®çƒ¤è‚ ', price: 98, image: 'IMG_5636.jpeg', category: 'é…¥çš®çƒ¤è‚ ç³»åˆ—', emoji: 'ğŸŒ­', },

      ];

      // --- STATE & INITIALIZATION ---
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      let currentOrder = null;
      
      initializeApp();
      
      function initializeApp() {
        renderCategoryNav();
        renderAllProducts();
        setupEventListeners();
        showToast('æ¬¢è¿å…‰ä¸´é”‹å‘³æ´¾å›¢è´­ï¼', 'success');
      }

      // --- RENDERING FUNCTIONS ---
      function renderAllProducts() {
        const productsListDiv = document.getElementById('productList');
        productsListDiv.innerHTML = '';
        const uniqueCategories = [...new Set(productsData.map(p => p.category))];
        
        uniqueCategories.forEach(category => {
            const categoryEmoji = productsData.find(p => p.category === category)?.emoji || 'âœ¨';
            const categoryHtmlId = `cat_${category.replace(/\s/g, '')}`;
            
            const categoryTitle = document.createElement('h3');
            categoryTitle.className = 'category-title';
            categoryTitle.id = categoryHtmlId;
            categoryTitle.innerHTML = `${categoryEmoji} ${category}`;
            productsListDiv.appendChild(categoryTitle);

            productsData.filter(p => p.category === category).forEach(product => {
              productsListDiv.appendChild(createProductElement(product));
            });
        });
        attachQuantityControlListeners();
        calculateTotal();
      }

      function createProductElement(product) {
          const productDiv = document.createElement('div');
          productDiv.className = 'product';
          if (product.stock === 0) productDiv.classList.add('out-of-stock');
          productDiv.dataset.id = product.id;

          let stockBadge = '';
          if (product.stock === 0) {
              stockBadge = `<div class="stock-badge out-of-stock-badge">å·²å”®å®Œ</div>`;
          } else if (product.stock > 0 && product.stock <= product.minStock) {
              stockBadge = `<div class="stock-badge low-stock-badge">åº“å­˜ç´§å¼ </div>`;
          }

          productDiv.innerHTML = `
              <div class="product-image-container">
                  <img src="${product.image}" class="product-image" alt="${product.name}">
                  ${stockBadge}
              </div>
              <div class="product-name">${product.emoji} ${product.name}</div>
              <div class="product-price">RM${product.price.toFixed(2)}</div>
              <div class="stock-info">åº“å­˜: ${product.stock}</div>
              <div class="quantity-control">
                  <button type="button" class="quantity-btn minus" ${product.stock === 0 ? 'disabled' : ''}>-</button>
                  <input type="number" class="quantity-input" data-id="${product.id}" data-price="${product.price}" value="0" min="0" max="${product.stock}" ${product.stock === 0 ? 'disabled' : ''}>
                  <button type="button" class="quantity-btn plus" ${product.stock === 0 ? 'disabled' : ''}>+</button>
              </div>`;
          return productDiv;
      }

      function renderCategoryNav() {
        const categoryLinksDiv = document.getElementById('categoryLinks');
        categoryLinksDiv.innerHTML = '';
        const allLink = document.createElement('a');
        allLink.href = '#';
        allLink.className = 'category-link active';
        allLink.textContent = 'å…¨éƒ¨å•†å“';
        allLink.addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelector('.main-container').scrollIntoView({ behavior: 'smooth' });
            setActiveCategoryLink(allLink);
        });
        categoryLinksDiv.appendChild(allLink);
        const uniqueCategories = [...new Set(productsData.map(p => p.category))].sort();
        uniqueCategories.forEach(category => {
            const categoryEmoji = productsData.find(p => p.category === category)?.emoji || 'âœ¨';
            const link = document.createElement('a');
            const categoryHtmlId = `cat_${category.replace(/\s/g, '')}`;
            link.href = `#${categoryHtmlId}`;
            link.className = 'category-link';
            link.textContent = `${categoryEmoji} ${category}`;
            link.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById(categoryHtmlId)?.scrollIntoView({ behavior: 'smooth' });
                setActiveCategoryLink(link);
            });
            categoryLinksDiv.appendChild(link);
        });
      }

      function setActiveCategoryLink(activeLink) {
        document.querySelectorAll('.category-link').forEach(l => l.classList.remove('active'));
        activeLink.classList.add('active');
      }

      // --- EVENT LISTENERS ---
      function setupEventListeners() {
          document.getElementById('orderForm').addEventListener('submit', handleFormSubmit);
          
          document.querySelectorAll('.form-control, textarea, #agreeCheckbox, #paymentProof').forEach(el => {
            const eventType = el.type === 'checkbox' || el.type === 'file' || el.tagName === 'SELECT' ? 'change' : 'input';
            el.addEventListener(eventType, () => clearError(el.closest('.form-group, .disclaimer-box').id));
          });
          
          document.getElementById('delivery').addEventListener('change', (e) => {
            document.getElementById('selfPickupAddress').style.display = e.target.value === 'self-pickup' ? 'block' : 'none';
          });
          
          document.getElementById('paymentMethod').addEventListener('change', handlePaymentMethodChange);
          document.getElementById('paymentProof').addEventListener('change', handleFileChange);
          document.getElementById('showExportBtn').addEventListener('click', () => {
            const panel = document.getElementById('adminPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
          });
          document.getElementById('realExportBtn').addEventListener('click', handleAdminExport);
      }
      
      function attachQuantityControlListeners() {
        document.querySelectorAll('.quantity-control').forEach(control => {
            const input = control.querySelector('.quantity-input');
            const productId = parseInt(input.dataset.id);
            control.querySelector('.plus').addEventListener('click', () => updateQuantity(productId, 1));
            control.querySelector('.minus').addEventListener('click', () => updateQuantity(productId, -1));
            input.addEventListener('input', () => {
                const product = productsData.find(p => p.id === productId);
                let value = parseInt(input.value) || 0;
                if (value < 0) value = 0;
                if (value > product.stock) {
                    value = product.stock;
                    showToast(`${product.name} åº“å­˜ä»…å‰© ${product.stock} ä»¶`, 'warning');
                }
                input.value = value;
                calculateTotal();
            });
        });
      }

      // --- HANDLERS & LOGIC ---
      function handlePaymentMethodChange(e) {
          const method = e.target.value;
          const detailsContainer = document.getElementById('paymentDetailsContainer');
          const maybankDiv = document.getElementById('maybankDetails');
          const tngDiv = document.getElementById('touchngoDetails');

          detailsContainer.style.display = 'none';
          maybankDiv.style.display = 'none';
          tngDiv.style.display = 'none';

          if (method) {
              detailsContainer.style.display = 'block';
              if (method === 'Maybank QR') {
                  maybankDiv.style.display = 'block';
              } else if (method === 'TNG eWallet') {
                  tngDiv.style.display = 'block';
              }
          }
      }

      function updateQuantity(productId, change) {
          const input = document.querySelector(`.quantity-input[data-id='${productId}']`);
          const product = productsData.find(p => p.id === productId);
          let currentVal = parseInt(input.value);
          let newVal = currentVal + change;
          if (newVal < 0) newVal = 0;
          if (newVal > product.stock) {
              newVal = product.stock;
              showToast(`${product.name} åº“å­˜ä»…å‰© ${product.stock} ä»¶`, 'warning');
          }
          input.value = newVal;
          calculateTotal();
      }

      function calculateTotal() {
          let total = 0;
          document.querySelectorAll('.quantity-input').forEach(input => {
            total += (parseInt(input.value) || 0) * parseFloat(input.dataset.price);
          });
          document.getElementById('totalAmount').textContent = total.toFixed(2);
          return total;
      }
      
      function handleFileChange(e) {
        const label = document.querySelector('.file-upload-label');
        const initialText = document.getElementById('fileUploadInitialText');
        const fileNameDisplay = label.querySelector('.file-name');
        if (e.target.files.length > 0) {
            fileNameDisplay.textContent = e.target.files[0].name;
            initialText.style.display = 'none';
        } else {
            fileNameDisplay.textContent = '';
            initialText.style.display = 'block';
        }
      }

      async function handleFormSubmit(e) {
          e.preventDefault();
          if (!validateForm()) return;
          currentOrder = await buildOrderData();
          showConfirmationDialog(currentOrder);
      }
      async function submitOrder(cartItems, customerInfo) {
  try {
    // æ­¥éª¤ 1ï¼šæ£€æŸ¥æ¯é¡¹å•†å“åº“å­˜ & æ˜¯å¦é™è´­
    for (const item of cartItems) {
      const { data: product, error } = await supabase
        .from('products')
        .select('stock, limit_purchase')
        .eq('id', item.id)
        .single();

      if (error || !product) {
        alert(`æ— æ³•è·å–å•†å“ã€Œ${item.name}ã€çš„ä¿¡æ¯`);
        return;
      }

      if (product.limit_purchase) {
        if (product.stock < item.quantity) {
          alert(`å•†å“ã€Œ${item.name}ã€åº“å­˜ä¸è¶³ï¼Œä»…å‰© ${product.stock} ä»¶`);
          return;
        }
      }
    }

    // æ­¥éª¤ 2ï¼šæäº¤è®¢å•
    const { data: orderResult, error: orderError } = await supabase
      .from('orders')
      .insert([{
        name: customerInfo.name,
        phone: customerInfo.phone,
        address: customerInfo.address,
        items: cartItems.map(i => ({
          product_id: i.id,
          quantity: i.quantity
        })),
        total: cartItems.reduce((sum, item) => sum + item.price * item.quantity, 0),
        status: 'pending',
        created_at: new Date().toISOString()
      }]);

    if (orderError) {
      alert('è®¢å•æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      return;
    }

    // æ­¥éª¤ 3ï¼šæ‰£é™¤åº“å­˜ï¼ˆä»…é™é™è´­å•†å“ï¼‰
    for (const item of cartItems) {
      const { data: product, error } = await supabase
        .from('products')
        .select('stock, limit_purchase')
        .eq('id', item.id)
        .single();

      if (product.limit_purchase) {
        await supabase
          .from('products')
          .update({ stock: product.stock - item.quantity })
          .eq('id', item.id);
      }
    }

    alert('è®¢å•æäº¤æˆåŠŸï¼æ„Ÿè°¢æ‚¨çš„æ”¯æŒ');
    // æ¸…ç©ºè´­ç‰©è½¦ã€è¡¨å•ã€å›é¦–é¡µç­‰æ“ä½œ...
  } catch (err) {
    console.error('è®¢å•å¤„ç†å¼‚å¸¸:', err);
    alert('ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•');
  }
}

      async function submitConfirmedOrder() {
          showDialog(false, 'confirmationDialog');
          showLoading(true);
          
          try {
            const file = document.getElementById('paymentProof').files[0];
            let paymentProofUrl = '';
            if (file) {
                const ext = file.name.split('.').pop();
                const filename = `proofs/${currentOrder.orderId}.${ext}`;
                const { error: uploadError } = await supabase.storage.from('payment-proofs').upload(filename, file, { upsert: true });
                if (uploadError) throw new Error(`å‡­è¯ä¸Šä¼ å¤±è´¥: ${uploadError.message}`);
                const { data: urlData } = supabase.storage.from('payment-proofs').getPublicUrl(filename);
                paymentProofUrl = urlData.publicUrl;
            }

            const { error: insertError } = await supabase.from('orders').insert([{
              order_id: currentOrder.orderId,
              name: currentOrder.name,
              phone: currentOrder.phone,
              delivery_method: currentOrder.delivery,
              payment_method: currentOrder.paymentMethod, // Save payment method
              remarks: currentOrder.remarks,
              order_items: currentOrder.items,
              total_amount: currentOrder.total,
              payment_proof_url: paymentProofUrl,
              status: 'pending',
              created_at: new Date().toISOString()
            }]);
            if (insertError) throw new Error(`è®¢å•ä¿å­˜å¤±è´¥: ${insertError.message}`);

            // Update local stock
            currentOrder.items.forEach(item => {
                const product = productsData.find(p => p.id === item.id);
                if (product) product.stock -= item.quantity;
            });
            
            showSuccessDialog();
            resetForm();
            renderAllProducts();
          } catch (error) {
            console.error('Submit Error:', error);
            showToast(error.message, 'danger');
          } finally {
            showLoading(false);
          }
      }

      function resetForm() {
          document.getElementById('orderForm').reset();
          document.querySelectorAll('.quantity-input').forEach(input => input.value = '0');
          calculateTotal();
          handleFileChange({target: {files:[]}});
          handlePaymentMethodChange({target: {value: ''}});
          document.getElementById('selfPickupAddress').style.display = 'none';
          document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
          currentOrder = null;
      }
      
      // --- VALIDATION ---
      function validateForm() {
          let isValid = true;
          let firstErrorElement = null;
          const setFirstError = (el) => { if (!firstErrorElement) firstErrorElement = el; };

          document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));

          if (!document.getElementById('agreeCheckbox').checked) {
              isValid = false; showError('disclaimerBox', 'è¯·å‹¾é€‰æ­¤é¡¹ä»¥ç»§ç»­');
              setFirstError(document.getElementById('disclaimerBox'));
          }
          if (!document.getElementById('name').value.trim()) {
              isValid = false; showError('nameGroup', 'è¯·è¾“å…¥å§“å');
              setFirstError(document.getElementById('nameGroup'));
          }
          const phone = document.getElementById('phone').value.trim();
          const phoneRegex = /^(\+?6?01)[0-46-9]-?[0-9]{7,8}$/;
          if (!phoneRegex.test(phone.replace(/-/g, ''))) {
              isValid = false; showError('phoneGroup', 'è¯·è¾“å…¥æœ‰æ•ˆçš„é©¬æ¥è¥¿äºšç”µè¯å·ç ');
              setFirstError(document.getElementById('phoneGroup'));
          }
          if (!document.getElementById('delivery').value) {
              isValid = false; showError('deliveryGroup', 'è¯·é€‰æ‹©å–è´§æ–¹å¼');
              setFirstError(document.getElementById('deliveryGroup'));
          }
          if (!document.getElementById('paymentMethod').value) {
              isValid = false; showError('paymentMethodGroup', 'è¯·é€‰æ‹©ä»˜æ¬¾æ–¹å¼');
              setFirstError(document.getElementById('paymentMethodGroup'));
          }
          if (calculateTotal() <= 0) {
              isValid = false; showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹å•†å“', 'warning');
              setFirstError(document.getElementById('productList'));
          }
          if (document.getElementById('paymentProof').files.length === 0) {
              isValid = false; showError('paymentProofGroup', 'è¯·ä¸Šä¼ æ”¯ä»˜å‡­è¯');
              setFirstError(document.getElementById('paymentProofGroup'));
          }

          if (!isValid && firstErrorElement) {
              firstErrorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
          return isValid;
      }

      function showError(groupId, message) {
          const group = document.getElementById(groupId);
          if (group) {
              group.classList.add('error');
              const errorMsgEl = group.querySelector('.error-message');
              if(errorMsgEl) errorMsgEl.textContent = message;
          }
      }

      function clearError(groupId) {
          document.getElementById(groupId)?.classList.remove('error');
      }

      // --- DATA BUILDERS ---
      async function buildOrderData() {
          const items = [];
          document.querySelectorAll('.quantity-input').forEach(input => {
            const quantity = parseInt(input.value);
            if (quantity > 0) {
              const product = productsData.find(p => p.id === parseInt(input.dataset.id));
              items.push({ id: product.id, product: product.name, quantity, price: product.price, emoji: product.emoji });
            }
          });
          
          const orderId = await generateOrderId();
          return {
            orderId,
            name: document.getElementById('name').value.trim(),
            phone: document.getElementById('phone').value.trim().replace(/-/g, ''),
            delivery: document.getElementById('delivery').value,
            paymentMethod: document.getElementById('paymentMethod').value,
            remarks: document.getElementById('remarks').value.trim(),
            items,
            total: calculateTotal(),
          };
      }
      
      async function generateOrderId() {
          const today = new Date();
          const datePrefix = `FW${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
          try {
            const { count, error } = await supabase.from('orders').select('order_id', { count: 'exact' }).like('order_id', `${datePrefix}%`);
            if (error) { throw error; }
            return `${datePrefix}${String(count + 1).padStart(3, '0')}`;
          } catch(error) {
            console.warn('Error fetching order count, falling back to timestamp ID.', error);
            return `FW${Date.now().toString().slice(-8)}`;
          }
      }

      function buildWhatsAppMessage(order) {
          let msg = `ğŸ›ï¸ *é”‹å‘³æ´¾æ–°è®¢å• #${order.orderId}*\n\n`;
          msg += `ğŸ‘¤ *å®¢æˆ·ä¿¡æ¯*\n`;
          msg += `  - å§“å: ${order.name}\n`;
          msg += `  - ç”µè¯: ${order.phone}\n`;
          msg += `  - å–è´§: ${order.delivery === 'self-pickup' ? 'è‡ªå–' : 'Lalamove'}\n`;
          msg += `  - ä»˜æ¬¾æ–¹å¼: ${order.paymentMethod}\n`;
          if (order.delivery === 'self-pickup') {
              msg += `  - åœ°å€: ${SELF_PICKUP_ADDRESS}\n`;
          }
          msg += `\nğŸ›’ *è®¢å•æ˜ç»†*\n`;
          order.items.forEach(item => {
            msg += `${item.emoji} ${item.product} Ã— ${item.quantity} = RM${(item.quantity * item.price).toFixed(2)}\n`;
          });
          msg += `\nğŸ’° *æ€»é‡‘é¢: RM${order.total.toFixed(2)}*\n`;
          msg += `ğŸ“ *å¤‡æ³¨*: ${order.remarks || 'æ— '}\n`;
          msg += `\nğŸ“… *ä¸‹å•æ—¶é—´*: ${new Date().toLocaleString('en-MY')}`;
          return msg;
      }
      
      // --- UI & UX FUNCTIONS (Dialogs, Toasts, Loader) ---
      function showLoading(show) {
          document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
      }

      function showDialog(show, dialogId) {
          document.getElementById(dialogId).style.display = show ? 'flex' : 'none';
      }

      function showConfirmationDialog(order) {
          const content = document.getElementById('confirmationContent');
          content.innerHTML = `
            <h3><i class="fas fa-clipboard-check"></i> è®¢å•ç¡®è®¤</h3>
            <p><strong>è®¢å•å·:</strong> ${order.orderId}</p>
            <p><strong>å§“å:</strong> ${order.name}</p>
            <p><strong>ç”µè¯:</strong> ${order.phone}</p>
            <p><strong>é…é€:</strong> ${order.delivery === 'self-pickup' ? 'è‡ªå–' : 'Lalamove'}</p>
            <p><strong>ä»˜æ¬¾æ–¹å¼:</strong> ${order.paymentMethod}</p>
            ${order.delivery === 'self-pickup' ? `<p><strong>è‡ªå–åœ°å€ï¼š</strong> ${SELF_PICKUP_ADDRESS}</p>` : ''}
            <hr/>
            <h4>è®¢å•æ˜ç»†</h4>
            <ul>${order.items.map(i => `<li>${i.product} Ã— ${i.quantity} = RM${(i.quantity * i.price).toFixed(2)}</li>`).join('')}</ul>
            <p style="font-weight:bold;text-align:right;">æ€»é‡‘é¢: RM${order.total.toFixed(2)}</p>
            <div class="dialog-footer">
              <button id="cancelConfirm" class="btn">å–æ¶ˆ</button>
              <button id="submitConfirm" class="btn">ç¡®è®¤å¹¶æäº¤</button>
            </div>`;
          showDialog(true, 'confirmationDialog');
          document.getElementById('cancelConfirm').onclick = () => showDialog(false, 'confirmationDialog');
          document.getElementById('submitConfirm').onclick = submitConfirmedOrder;
      }

      function showSuccessDialog() {
          const content = document.getElementById('successContent');
          const whatsappMsg = buildWhatsAppMessage(currentOrder);
          content.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <h3>è®¢å•æäº¤æˆåŠŸï¼</h3>
            <p>æ‚¨çš„è®¢å• #${currentOrder.orderId} å·²æˆåŠŸä¿å­˜ã€‚</p>
            <p>è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œé€šè¿‡WhatsAppå‘é€è®¢å•è¯¦æƒ…ä»¥å®Œæˆæµç¨‹ã€‚</p>
            <div class="dialog-footer">
              <button id="successConfirm" class="btn">å‰å¾€WhatsAppå‘é€</button>
            </div>`;
          showDialog(true, 'successDialog');
          document.getElementById('successConfirm').onclick = () => {
              showDialog(false, 'successDialog');
              window.location.href = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(whatsappMsg)}`;
          };
      }
      
      function showToast(message, type = 'success') {
          const container = document.getElementById('toastContainer');
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;
          const icons = { success: 'fa-check-circle', danger: 'fa-times-circle', warning: 'fa-exclamation-triangle' };
          toast.innerHTML = `<i class="fas ${icons[type]}"></i><span>${message}</span>`;
          container.appendChild(toast);
          setTimeout(() => toast.remove(), 3000);
      }

      // --- ADMIN FUNCTIONS ---
      async function handleAdminExport() {
          if (document.getElementById('adminPassword').value !== ADMIN_PASSWORD) {
              return showToast('ç®¡ç†å‘˜å¯†ç é”™è¯¯', 'danger');
          }
          showLoading(true);
          try {
            const { data: orders, error } = await supabase
              .from('orders').select('*').order('created_at', { ascending: false });
            if (error) throw error;
            if (!orders || orders.length === 0) {
                showToast('æ²¡æœ‰è®¢å•æ•°æ®å¯ä¾›å¯¼å‡º', 'warning');
                return;
            }

            const wsData = [['è®¢å•å·', 'å§“å', 'ç”µè¯', 'é…é€æ–¹å¼', 'ä»˜æ¬¾æ–¹å¼', 'å¤‡æ³¨', 'æ€»é‡‘é¢', 'çŠ¶æ€', 'ä¸‹å•æ—¶é—´', 'æ”¯ä»˜å‡­è¯URL', 'äº§å“æ˜ç»†']];
            orders.forEach(order => {
              const productDetails = Array.isArray(order.order_items)
                ? order.order_items.map(item => `${item.product || 'N/A'} x ${item.quantity || 0}`).join('; ') : 'æ— äº§å“ä¿¡æ¯';
              wsData.push([
                order.order_id, order.name, order.phone, order.delivery_method,
                order.payment_method || 'N/A', order.remarks || 'æ— ', 
                order.total_amount, order.status,
                new Date(order.created_at).toLocaleString('en-MY'),
                order.payment_proof_url || 'æ— ', productDetails
              ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'è®¢å•æ•°æ®');
            XLSX.writeFile(wb, `é”‹å‘³æ´¾è®¢å•_${new Date().toISOString().slice(0, 10)}.xlsx`);
            showToast('å¯¼å‡ºæˆåŠŸï¼', 'success');
          } catch (error) {
            console.error('Export Error:', error);
            showToast(`å¯¼å‡ºè®¢å•æ—¶å‡ºé”™: ${error.message}`, 'danger');
          } finally {
            showLoading(false);
          }
      }
    });
  </script>
</body>
</html>
